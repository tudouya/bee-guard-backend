# AGENTS.md — Bee Guard Backend Agent Guide

本文件为在本仓库内工作的智能体（Agent）提供明确的约束、决策与开发流程指导。其范围覆盖本仓库根目录及所有子目录。

— 本文档将随着需求与设计演进而更新。


## 1) 作用域与优先级规则（Agent 必读）
- 作用域：本文件适用于整个仓库目录树。
- 遵循顺序：用户/开发者明确指令 > 更深层级目录的 AGENTS.md > 本文件。
- 若文件树中存在多个 AGENTS.md，越深层的优先生效（仅在其作用域内）。
- 本文件中的编码规范、结构与命名等指导仅适用于本仓库，不外溢至其他项目。
- 修改代码前请通读：问题要在根因处解决，避免引入不相关变更。


## 2) 技术栈与运行方式
- 后端框架：Laravel 12（PHP 8.2）。
- 后台面板：Filament v4（计划两套面板：admin/enterprise）。
- 前端构建：Vite 7 + Tailwind CSS 4。
- 数据库：SQLite（默认，开发）；可迁移至 MySQL/PostgreSQL。
- 依赖管理：Composer（PHP），npm（前端）。
- 本地开发：
  - 安装依赖：`composer install && npm install`
  - 环境：复制 `.env.example` 为 `.env`，`php artisan key:generate`
  - 迁移：`php artisan migrate`
  - 一键多进程：`composer dev`（serve/queue/logs/vite）
  - 测试：`composer test`（PHPUnit 11，内存 SQLite）


## 3) 认证与角色（已确认的关键决策）
- 小程序端认证：仅使用微信登录（code2session），不使用 OTP（短信/邮箱）登录。
- 后台登录：账号密码（Filament 默认登录）。
- 角色集合：
  - `super_admin`（超管）：全平台配置/审核/数据权限。
  - `enterprise_admin`（企业）：仅管理所属企业数据与功能。
  - `farmer`（蜂农）：小程序端用户。
- 用户统一表：`users`（统一存储身份信息）。
  - 小程序用户：在 `users` 表中保存 `openid`（唯一、可空）、`unionid?`、`session_key`（加密存储）。
  - 管理员/企业用户：上述字段留空。
- 企业归属：不在 `users` 上存放 `enterprise_id`。改为企业关联用户：
  - `enterprises.user_id` 指向企业“主账号”用户（可为空，创建后再指派）。
  - 关系为一对多：一个用户可以拥有多个企业（`users.id -> enterprises.owner_user_id`）。
  - 蜂农不绑定企业（企业关系通过“检测号来源”与检测记录体现）。


## 4) 领域模型（初版草案，供实现参考）
- 用户与组织
  - `users`：通用用户主体（`role`、昵称/头像、可空 `openid` 唯一、`unionid?`、`session_key` 加密、`last_login_at`）。
  - `enterprises`：企业资料、联系人、状态、`owner_user_id`（企业主账号）。
- 检测与订单
  - `detection_codes`： 采样码，来源类型（`gift|self_paid`）、企业/渠道、状态（`available|assigned|used|expired`）、绑定用户、使用时间。
  - `orders`：自费订单（微信支付），`user_id`、`detection_code_id`、金额、状态、支付渠道、交易号。
  - `detections`：一次检测主记录（`user_id`、`detection_code_id`、样品编号、省/市/县、提交时间等）。
  - `questionnaires`：问卷（`detection_id`、JSON 答案）。
  - `diseases`：病种字典（SBV、IAPV、BQCV、AFB、EFB、微孢子虫、白垩病等）。
  - `detection_results`：检测结果明细（`detection_id`、`disease_id`、`result=positive|negative`、说明/建议）。
- 推荐与产品
  - `products`：企业产品（名称、简介、链接、媒体）。
  - `disease_product`：病种与产品映射（多对多）。
  - `recommendation_rules`：推荐规则（ZF 自费全局推荐、赠送码按企业推荐）。
- 知识与互动
  - `posts`：`type=question|experience`、作者、内容、媒体、`status=pending|approved|rejected`、`disease_id?`、`views`、`likes`。
  - `replies`：问题回复（管理员/企业，可标注“平台建议/企业建议”）。
  - `reward_rules`：优质内容识别门槛/奖励配置（点击/点赞阈值，自动/人工）。
  - `coupons`/`coupon_grants`：代金券定义与发放记录。
- 地区
  - `regions`：省/市/县（首期可用简单字段，后续导入全国行政区库）。
- 审计与审核（建议）
  - 统一 `status` 字段与 `reviewed_by/at`；或独立 `audits` 表记录审核轨迹。


## 5) 业务模块与流程（按需求整理）
### 5.1 前端用户模块（蜂农端，小程序）
- 检测入口（有检测号）
  - 输入检测号与手机号（作为业务字段，不用于登录）→ 校验并绑定 → 问卷 → 提交 → 样品邮寄说明。
  - 检测号一次性使用：提交问卷/生成样品记录后原子化标记 `used`。
- 自费通道（无检测号）
  - 引导支付 → 选择检测项目与价格（可配置） → 微信支付 → 成功后分配自费检测号（示例前缀 `ZF`，编码规则可配置）→ 问卷 → 邮寄说明。
- 检测结果查询
  - 微信登录成功后，展示该用户全部检测记录（自费与赠送）。
  - 列表字段：样品编号、检测号、提交时间、病种与结果、推荐方法、产品推荐。
- 推荐产品
  - 赠送检测号：显示该企业配置的推荐。
  - 自费检测号（ZF）：显示管理员全局推荐。
- 疫情查询
  - 省/市/县筛选；阳性数据分布（病种维度）与时间趋势（按月）。
- 防控知识
  - 蜂病百科：简介/症状/传播/诊断/防控方案/推荐产品链接。
  - 技术经验互动：蜂农提问（图文/视频，需审核）、经验分享（需审核），平台/企业可回复。设立激励机制（阈值→优质内容→代金券/勋章等）。
- 安全与验证
  - 检测号一次性、记录绑定到用户（非手机号）且归属明确；内容均需审核后展示。

### 5.2 系统管理员模块（后台管理）
- 检测号池管理：导入/生成/状态流转，关联企业与渠道。
- 检测数据管理：按手机号（业务字段）与用户聚合；录入/导入结果；驱动疫情图。
- 互动内容审核管理：提问/经验/回复的审核、过滤、隐藏/恢复/封禁。
- 推荐配置：疾病-产品推荐库；企业提交内容需初审。
- 权限与模块配置：角色与模块可见性；用户反馈与行为数据。

### 5.3 企业用户模块（后台管理）
- 企业注册与登录：账号密码/或由管理员分配并审核。
- 客户检测结果查看：基于使用该企业检测号的蜂农数据；支持时间/地区/病种/结果维度筛选与统计。
- 数据可视化：趋势图、热力图、分布饼图（支持筛选）。
- 产品推荐管理：按病种配置产品与内容；检测结果页向蜂农展示。
- 品牌与内容：回复蜂农提问（标注企业建议）、投稿知识内容（需管理员初审）。
- 代金券：赞助激励配置与发放统计。


## 6) 后台面板（Filament）与访问控制
- 计划提供两个 Panel：
  - `/admin`：超管专用，仅 `super_admin` 可访问。
  - `/enterprise`：企业面板，仅 `enterprise_admin` 可访问。
- 资源建议：用户、企业、检测号、订单、检测记录、问卷、病种、检测结果、产品、病种-产品映射、推荐规则、内容（提问/经验/回复）审核、奖励规则、代金券、发放记录、地区/字典、仪表盘统计。


## 7) API 原则与约定
- 认证：小程序端使用 Sanctum Token；登录接口仅接受 `code` 并服务端与微信交互校验。
- 响应：JSON；分页统一（`page`/`per_page`），统一错误码与错误体结构（保留 `code`、`message`、`errors`）。
- 校验：使用 Form Request；对状态流转（如检测号使用）采用事务与乐观约束（唯一索引）防止并发重复使用。
- 资源命名：REST 优先，必要时用动词子路径表述动作（如 `/wechat/notify`）。
- 推荐：按“检测号来源企业或自费”动态计算，尽量通过查询组合或缓存实现。
- 日志与审计：关键动作写入审计日志（创建/审核/发放/状态变更）。


## 8) 编码规范与变更约束
- 语言与标准：PHP 8.2，PSR-12，遵循 Laravel 惯例（Eloquent 命名、迁移命名、Seeder/Factory 使用）。
- 变更范围：仅实现与当前任务直接相关的代码；避免“顺手修复”不相关问题（可在说明中指出）。
- 迁移与数据：
  - 新增字段/表使用迁移；必要时添加唯一索引与检查约束以固化业务规则（如检测号唯一、手机号唯一、openid 唯一）。
  - 涉及状态机的流程（检测号使用）务必在事务内完成并保证原子性。
- 面板资源：使用 Filament Resource 与 Relation Manager；遵循面板的导航结构与授权策略。
- 安全：输入严格校验；上传文件校验类型与大小；敏感字段（如 `session_key`）加密保存。
- 配置：所有外部依赖（微信、支付、存储等）通过 .env 配置，并提供开发环境 Mock 开关。


## 9) 测试与验证
- 测试优先靠近改动：为关键领域服务与控制器添加 Feature/Unit 测试。
- 使用内存 SQLite 运行测试（`phpunit.xml` 已配置）。
- 不存在既有测试时，新增紧贴改动的最小必要测试；不要为不相关模块补测。


## 10) 本地开发与 Mock
- 微信登录在无外网时允许启用 Mock 驱动：根据 `WECHAT_MOCK=true` 生成可重复的 `openid`，便于联调。
- 支付回调允许提供本地伪造通知端点，串通订单→分配检测号→问卷流程。


## 11) 未决事项（待产品确认）
- 自费检测号前缀是否固定为 `ZF`，编码格式是否为 `ZFYYYYMMDDNNN`？
- 行政区使用方案：是否先用简单省市县字段，后续导入全国行政区标准库？
- 推荐算法是否需要 A/B 或权重配置，还是静态映射为主？
- 是否需要短信能力（非登录场景，如通知备用）？


## 12) 快速清单（Agent 执行时自查）
- 是否遵循了本文件与更深层 AGENTS.md 的要求？
- 是否使用迁移而非直接改库？是否添加必要索引/约束？
- 是否避免引入与任务无关的变更？
- 是否提供了最小必要测试或说明验证步骤？
- 是否将外部集成做成可配置并提供 Mock？


## 13) 变更记录
- 2025-09-12：首版建立，整合产品需求与开发约束，明确“微信登录、三角色、两面板”的核心决策；沉淀数据模型与流程骨架。
