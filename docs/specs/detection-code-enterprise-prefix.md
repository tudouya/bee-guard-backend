# 检测号前缀（企业自定义）规划说明

本文档说明“企业自定义检测号前缀”的需求与落地方案（仅文档，不涉及当前代码改动），用于后续按需排期实现。

## 背景与目标
- 背景：当前检测号包含 `prefix + code`，默认前缀为：自费(ZF)、赠送(QY)。部分企业希望其赠送检测码使用企业专属前缀，便于对外传播、运营统计与售后定位。
- 目标：当来源为企业赠送（gift）且选择了企业时，优先使用企业自定义前缀；未设置时回退到系统默认前缀（QY）。不改变既有码的有效性与查询方式。

## 数据模型与约束（规划）
- enterprises 表新增字段：
  - `code_prefix` varchar(16) NULL
  - 约束建议：
    - 字符集：仅大写字母/数字/连字符（按现有前缀长度限制，默认 16）。
    - 非唯一（不同企业可用相同前缀，查找以 `enterprise_id` + `prefix` + `code` 为准）。如需唯一性，可在产品层面限制。
  - 迁移（示意）：
    - `Schema::table('enterprises', fn($t) => $t->string('code_prefix', 16)->nullable());`

- detection_codes 表保持不变：
  - `prefix` 与 `code` 继续存储完整号码的两部分。
  - 关系：`detection_codes.enterprise_id` 已存在，生成或导入时可关联企业并写入前缀。

## 业务规则（优先级）
- 获取前缀逻辑（仅 gift）：
  1) 若 `enterprise.code_prefix` 存在，则使用之。
  2) 否则使用系统默认 `DetectionCode::DEFAULT_PREFIX_GIFT`（当前为 QY）。
- 自费码（self_paid）不受企业前缀影响，仍使用系统默认 `DetectionCode::DEFAULT_PREFIX_SELF`（当前为 ZF）。
- 历史数据不回填；已存在的检测码前缀保持不变。

## 面板与体验（规划）
- 企业管理（EnterpriseResource）：
  - 新增“检测号前缀（可选）”字段，校验：大写、长度 ≤16、可含字母数字与连字符。
  - 保存后立即生效（仅影响新生成/导入的 gift 检测码）。

- 检测码管理（DetectionCodeResource）：
  - 当 `source_type=gift` 且选择企业时，前缀自动预填为企业前缀；如企业未设置则预填系统默认（QY）。
  - 允许管理员在创建时手动覆盖（保留灵活性），但建议默认即可。
  - 批量导入/生成（若后续提供）也遵循上述逻辑。

## API 与对接（兼容）
- 用户端：
  - 仍使用 `detection_number = prefix + code` 作为输入/展示，不需要修改。
  - verify-bind、问卷、邮寄与结果查询等接口无需变更。

- 管理端：
  - 如需导出或统计，可按 `enterprise_id` + `prefix` 聚合分析。

## 校验与风控（建议）
- 前缀校验：
  - 格式：正则 `^[A-Z0-9-]{1,16}$`，统一转换为大写。
  - 保留黑名单（如与自费前缀冲突 `ZF` 可提示），由产品决定是否限制重复。

## 实施步骤（建议，不排期）
- 第 1 步：新增迁移与企业面板字段（不影响现有流程）。
- 第 2 步：在检测码创建/导入处引入“企业优先”的前缀取值逻辑（UI 预填 + 服务端兜底）。
- 第 3 步：数据导出与统计报表按企业前缀展示（可选）。

## 回滚与兼容
- 若企业前缀被移除（置空），后续新生成码回退到系统默认；已生成的历史检测码不受影响。

## FAQ
- Q：不同企业能否使用相同前缀？
  - A：技术上允许；如需避免混淆，可在企业创建/编辑时做唯一性提示或管理员审核。
- Q：是否影响验证与查询？
  - A：不影响；用户仍输入完整检测号（prefix+code），内部以组合匹配。
- Q：是否影响并发安全？
  - A：不影响；并发安全仍由 `detection_codes.code` 唯一与状态机事务保障。

