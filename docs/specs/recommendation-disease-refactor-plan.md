# 方案 B：检测结果明细化重构计划（消除硬编码映射）

## 目标
- 将检测结果从宽表字段迁移到明细表，彻底消除“病种 code ↔ 字段名”硬编码，病种字典变更可直接生效。
- 推荐链路、统计、接口读取均基于明细表，支持虫害与新增病种无需改代码/表结构即可参与。

## 范围
- 数据模型：新增明细表，保留病种字典与产品映射；处理虫害等非 RNA/DNA 病种。
- 写路径：录入/导入/后台编辑检测记录写入明细表（过渡期双写）。
- 读路径：检测结果列表/详情接口、推荐引擎、统计报表改为读明细表（过渡期可双读校验）。
- 迁移：历史宽表数据回填到明细表；确保接口兼容小程序现有字段形状。

## 目标数据模型（草案）
- `detection_results`（新表）
  - `id`
  - `detection_id` (fk detections)
  - `disease_id` (fk diseases)
  - `level` (enum: negative|null|weak|medium|strong|present|absent，或 text 以便扩展)
    - 语义：
      - `negative`/`null`：阴性/未检测
      - `weak`/`medium`/`strong`：定量/半定量结果等级（沿用 RNA/DNA 现有值）
      - `present`：存在/布尔 true（用于虫害等布尔型结果）
      - `absent`：不存在/布尔 false（用于虫害等布尔型结果）
  - `source` (可选：manual/import/lab_sync，用于审计)
  - `remark` (可选)
  - 唯一约束：(`detection_id`,`disease_id`)
  - 索引：`detection_id`、`disease_id`
- 病种字典：`diseases.code` 继续作为外部/业务标识（API 返回、配置/导入、数据交换用），内部关联通过 `disease_id` 完成；虫害等需有独立记录，可保留 `map_*` 字段。
- 产品映射：`disease_product` 保持不变。

## 迁移策略
1) **建立新表与支持字段**
   - 创建 `detection_results` 表（含唯一约束与必要索引）。
   -（可选）在 `diseases` 增加类型字段 `category`（rna/dna/pest/other）便于展示与过滤。
2) **数据回填**
   - 脚本/迁移读取宽表字段：
     - RNA/DNA：将 weak/medium/strong 写入对应病种的明细记录，其余视为 negative/null。
     - 虫害：布尔 true 记为 `present`（或 `weak`），false/NULL 记为 `absent`/`negative`。
   - 未找到病种 code 的字段记录可暂存为 `disease_id=null` 备查，并输出审计报告。
3) **双写/双读过渡**
   - 录入/编辑：同时写宽表和明细表，确保已有流程不被中断。
   - 接口：新增配置开关（或环境变量）控制是否从明细表读取；先双读对比，确认一致后切换为单读明细表。
4) **切换与收尾**
   - 切换读路径为明细表后，停用宽表读；宽表字段保留一段观察期。
   - 评估后可逐步废弃宽表字段（需要评审与数据备份）。

## 写路径改造点
- Filament 后台检测记录表单：提交时写入/更新 `detection_results`；过渡期保留对宽表字段的赋值。
- 导入/批量录入脚本：改为写明细表；必要时仍填宽表以供回滚。
- 实验室数据同步（若有）：接口/任务改为写明细表。

## 读路径与接口兼容
- `/api/detections` 列表与 `/api/detections/{id}` 详情：
  - `positives`/`positiveCount` 改为基于明细表查询（阳性判定规则：RNA/DNA weak+；虫害 present/true）。
  - 结果集形状保持不变，内部数据来源替换。
- 推荐引擎：
  - 直接根据明细表的阳性病种 code 列表构建 `disease_id`，不再依赖宽表映射。
- 统计/报表：
  - 病种分布、趋势等需改为聚合明细表，确认查询性能与索引。

## 迁移任务清单（可拆迭代，按模块细化）
1) 数据结构（数据库）
   - [ ] 创建 `detection_results` 表及索引/唯一约束；`level` 枚举含注释语义。
   - [ ]（可选）`diseases` 增加 `category` 字段；必要时补充状态索引。
   - [ ] `diseases` 增加 `detection_field` 以支持回填映射（字段名绑定）。
   - [ ] 迁移执行与回滚预案：确认已在各环境运行，记录版本号。
   - [ ] 为回填/审计预留临时表或日志表（可选）。

2) 数据准备（字典与映射）
   - [ ] 确认 `diseases` 覆盖虫害等全部病种；如缺失补录（code、name、category、status）。
   - [ ] 补充 `disease_product`，将虫害等病种关联已有产品（含企业产品）。

3) 数据回填（脚本/命令）
   - [ ] 编写命令：遍历宽表字段生成 `detection_results` 记录。
     - RNA/DNA：weak/medium/strong → 同名 level；其他 → negative/null。
     - 虫害布尔：true→present，false/null→absent（或 negative，需前后端确认展示）。
   - [ ] 输出审计日志：缺少病种映射、重复记录、写入失败等。
   - [ ] 支持幂等（可重复运行），必要时批处理与进度输出。

4) 写路径（应用层）
   - API/任务/后台共通：
     - [ ] 新增 `DetectionResult` 模型及关系（`Detection` hasMany）。
     - [ ] 封装写入服务，过渡期双写宽表 + 明细表。
   - Filament 后台检测记录表单：
     - [ ] 保存时写明细表（覆盖/删除旧结果再写入）；维持宽表字段写入以便回滚。
   - 导入/批量任务（若有）：
     - [ ] 改为写明细表，同时写宽表。
   - 实验室同步/队列（若有）：
     - [ ] 改为写明细表，同时写宽表。

5) 读路径（应用层与接口）
   - API `/api/detections` 列表、`/api/detections/{id}` 详情：
     - [ ] 增加开关支持从明细表读取阳性/结果；双读对比日志。
     - [ ] `positives`/`positiveCount` 基于明细表（含虫害 present）。
   - 推荐引擎：
     - [ ] 改为从明细表获取阳性病种 code 列表，不再依赖宽表映射。
   - 统计报表（若有病种分布/趋势）：
     - [ ] 改为聚合明细表，验证索引与性能。

6) 开关与切换
   - [ ] 配置开关控制读路径（宽表/明细表）；默认双读对比。
   - [ ] 观察期内保持双写，待稳定后切换为单读明细表。

7) 收尾与治理
   - [ ] 评估并决策是否废弃宽表字段（或置为只读备份）。
   - [ ] 更新文档/运维手册，通知前端：`positiveCount` 现在包含虫害等病种。
   - [ ] 留存回滚预案：如需快速回退可切回宽表读，明细表数据已同步。

## 影响面一览（需评估/改造的模块与接口）
- **API（小程序端）**
  - `/api/detections` 列表：阳性/阳性数来源切到明细表，含虫害；需校验分页性能。
  - `/api/detections/{id}` 详情：结果、positives/positiveCount、推荐数据源切换；保持响应形状兼容。
  - 疫情数据：
    - `/api/epidemic/distribution`
    - `/api/epidemic/trend`
    改为聚合明细表，确认病种过滤、地区筛选与索引。
- **推荐**
  - 推荐引擎阳性输入来自明细表；`recommendation_rules`、`disease_product` 不变，但需确保虫害等病种可命中。
- **后台（Filament）**
  - 检测记录 Resource：表单写明细表，详情/列表若显示阳性或推荐需改读路径。
  - 病种/产品/映射 Resource：保证新增病种（含虫害）可被绑定产品并参与推荐；如有“病种知识”展示，需确认数据源。
- **导入/批处理/实验室同步**
  - 现有导入脚本、实验室数据同步、定时任务（若有）需改写明细表并保留宽表写入。
- **统计与报表**
  - 病种分布、趋势、阳性率等统计改为基于明细表；确认缓存策略与索引（按地区/月份/病种）。
- **缓存/搜索**
  - 如有结果相关的缓存键或搜索索引（ES/Meilisearch 等），需要调整数据来源与失效策略。
- **测试与验证**
  - API/服务层测试补充明细表路径；数据回填与双读对比的审计输出需有覆盖。

## 停用宽表步骤（完全切到明细表）
1) 写路径改造为仅写明细表
   - 后台表单/导入/实验室同步/脚本等所有写结果入口改为直接写 `detection_results`，不再写宽表字段；如需回滚通道，可保留开关。
   - 确认回填完成，`detection_results` 数据完整。
2) 读路径无回退（已完成）
   - API/推荐/统计仅读明细表，无明细则返回空/阴性，不再访问宽表。
3) 清理依赖与字段
   - 在完全不依赖宽表映射时，可移除 `diseases.detection_field`，同步清理同步/回填中的映射代码。
   - 备份宽表数据后，迁移删除宽表结果字段（RNA/DNA/虫害列等），或将其置为只读备份。
4) 回归与观测
   - 跑全量测试与关键接口回归（检测详情/列表、推荐、疫情分布/趋势），确认数据一致。
   - 观察期内监控是否有漏写/缺数据。
5) 文档与运维
   - 更新运维手册，注明“仅明细表生效”，记录回滚策略（可保留宽表快照）。

## 风险与缓解
- **数据不一致**：回填/双读比对，用审计日志捕获差异并人工修正。
- **性能影响**：明细表查询需索引与预加载；大分页需验证；必要时加缓存或物化视图。
- **前端兼容**：返回形状不变，但阳性数量含虫害等；需沟通预期。
- **切换回滚**：保留宽表双写，若发现问题可快速切回宽表读；回滚步骤需预演。

## 里程碑（建议）
1) 设计评审与表结构确定。
2) 建表与回填脚本落地，完成一次全量回填并审计。
3) 写路径双写上线，接口双读观测一周。
4) 切换接口到明细表单读，继续观察。
5) 决策是否下线宽表字段或保留只读。
